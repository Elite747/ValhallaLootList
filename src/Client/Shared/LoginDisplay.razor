@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@inject NavigationManager Navigation
@inject SignOutSessionStateManager SignOutManager

<AuthorizeView>
    <Authorized>
        <MudHidden Breakpoint="Breakpoint.Xs">
            @{
                var username = context.User.Identity?.Name;
                var discordName = context.User.GetDiscordUsername();
            }
            @if (username != discordName)
            {
                @username
            }
            else
            {
                @discordName<span class="font-weight-light text-muted">#@context.User.GetDiscordDiscriminator()</span>
            }
        </MudHidden>
        <MudAvatar Class="mx-1" Color="Color.Transparent">
            <GuildMemberAvatar Id="context.User.GetDiscordIdFromClient()"
                               AvatarHash="@context.User.GetDiscordAvatarHash()"
                               Discriminator="context.User.GetDiscordDiscriminator()"
                               Size="40" />
        </MudAvatar>
        <MudButton OnClick="BeginSignOut" Variant="Variant.Text" Color="Color.Inherit">Log out</MudButton>
    </Authorized>
    <NotAuthorized>
        <MudButton OnClick="SignIn" Variant="Variant.Text" Color="Color.Inherit">Log in</MudButton>
    </NotAuthorized>
</AuthorizeView>

@code{
    private async Task BeginSignOut()
    {
        await SignOutManager.SetSignOutState();
        Navigation.NavigateTo("authentication/logout");
    }

    private void SignIn()
    {
        Navigation.NavigateTo("authentication/login?returnUrl=" + Navigation.Uri);
    }
}
