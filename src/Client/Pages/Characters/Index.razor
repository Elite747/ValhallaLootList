@page "/characters"
@inject ApiClient Api
@inject NavigationManager Nav
@inject IDialogService DialogService

<div class="d-flex align-center mb-3">
    <MudText Typo="Typo.h4" GutterBottom="false">Characters</MudText>

    <AuthorizeView Context="auth">
        <MudTooltip Text="Add Character">
            <MudIconButton OnClick="() => CreateClickedAsync(auth)" Color="Color.Primary" Icon="@Icons.Material.Filled.Add" />
        </MudTooltip>
    </AuthorizeView>

    <MudTooltip Text="Refresh">
        <MudIconButton OnClick="() => _executor?.RestartAsync() ?? Task.CompletedTask" Icon="@Icons.Material.Filled.Refresh" />
    </MudTooltip>
</div>


<ApiExecutor Operation="Api.Characters.GetAll" @ref="_executor" Context="characters">
    <MudPaper Elevation="5">
        <MudList Clickable="true">
            <MudListSubheader Class="d-flex align-center">
                <MudTextField @bind-Value="_searchText"
                              Immediate="true"
                              Label="Find Character"
                              Variant="Variant.Filled"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Filled.Search" />

            </MudListSubheader>
            @foreach (var ch in EnumerateCharacters(characters))
            {
                <MudListItem Href="@("characters/" + ch.Name)">
                    <div class="d-flex">
                        <PlayerIcon Race="ch.Race"
                                    Gender="ch.Gender"
                                    PlayerClass="ch.Class"
                                    Size="Size.Small"
                                    Class="mr-1" />
                        <MudText Inline="false">@ch.Name</MudText>
                    </div>
                </MudListItem>
            }
        </MudList>
    </MudPaper>
</ApiExecutor>

@code {
    private ApiExecutor<IList<CharacterDto>>? _executor;
    private string _searchText = string.Empty;

    private IEnumerable<CharacterDto> EnumerateCharacters(IList<CharacterDto> characters)
    {
        if (characters.Count > 0 && _searchText?.Length > 0)
        {
            const CompareOptions compareOptions = CompareOptions.IgnoreNonSpace | CompareOptions.IgnoreCase;
            return characters.Where(ch => ch.Name?.Length > 0 && CultureInfo.CurrentCulture.CompareInfo.IndexOf(ch.Name, _searchText, compareOptions) >= 0);
        }
        return characters;
    }

    private async Task CreateClickedAsync(AuthenticationState auth)
    {
        var character = await DialogService.ShowAsync<Create, CharacterDto>(
            "Create Character",
            parameters: new()
            {
                [nameof(Create.AllowSubmitNonOwned)] = auth.User.IsAdmin(),
                [nameof(Create.DefaultSenderIsOwner)] = true
            },
            options: new() { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true });
        if (character is not null)
        {
            Nav.NavigateTo("/characters/" + character.Name);
        }
    }
}
