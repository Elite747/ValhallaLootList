@page "/Teams/{team}"
@inject ApiClient Api
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<ApiExecutor Operation="() => Api.Teams.Get(Team)" Context="team" @ref="_executor">
    <h1>@team.Name</h1>

    @foreach (var schedule in team.Schedules)
    {
        var startDate = new DateTime(schedule.RealmTimeStart.Ticks);
        <h4>@(schedule.Day)s from @(startDate.ToString("t", CultureInfo.CurrentCulture)) to @(startDate.Add(schedule.Duration).ToString("t", CultureInfo.CurrentCulture))</h4>
    }

    <p>
        <a href="Teams/@team.Name/Standings">View Loot Standings</a>
    </p>

    <AuthorizeView Roles="@AppRoles.RaidLeader">
        <MudButton OnClick="() => StartRaid(team)" Variant="Variant.Filled" Color="Color.Primary">Start Raid</MudButton>
    </AuthorizeView>

    <MudGrid Class="my-5">
        <MudItem lg="6" xl="4">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Roster</MudText>
                        <AuthorizeView Roles="@AppRoles.RaidLeader">
                            <MemberAdder Team="team" />
                        </AuthorizeView>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudList>
                    @foreach (var ch in team.Roster.OrderByRoleThenClassThenName())
                    {
                        var character = ch;
                        <MudListItem Class="@("d-flex jusify-content-between align-items-center bg-pc" + ch.Class.GetLowercaseName())">
                            <a href="characters/@character.Name">@character.Name</a>
                            <span>
                                <RaceIcon Size="IconSize.Small" Race="character.Race" Gender="character.Gender" />
                                @if (character.CurrentPhaseMainspec.HasValue)
                                {
                                    <SpecIcon Size="IconSize.Small" Spec="character.CurrentPhaseMainspec.Value" />
                                }
                                else
                                {
                                    <ClassIcon Size="IconSize.Small" PlayerClass="character.Class" />
                                }
                                <AuthorizeView Roles="@AppRoles.RaidLeader">
                                    <MudTooltip Text="Remove Member">
                                        <MudIconButton OnClick="() => RemoveMemberAsync(team, character)" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" />
                                    </MudTooltip>
                                </AuthorizeView>
                            </span>
                        </MudListItem>
                    }
                </MudList>
            </MudCard>
        </MudItem>
    </MudGrid>

    <RaidCalendar Team="team" />
</ApiExecutor>

@code {
    private IApiExecutor? _executor;

    [Parameter] public string Team { get; set; } = string.Empty;

    private async Task RemoveMemberAsync(TeamDto team, TeamCharacterDto character)
    {
        if (await DialogService.ShowAsync<RemoveMemberDialog, bool>("Remove Member", new() { [nameof(RemoveMemberDialog.CharacterName)] = character.Name }))
        {
            await Api.Teams.RemoveMember(team.Id, character.Id)
                .OnSuccess(_ =>
                {
                    team.Roster.Remove(character);
                    StateHasChanged();
                })
                .SendErrorTo(Snackbar)
                .ExecuteAsync();
        }
    }

    private void StartRaid(TeamDto team)
    {
        DialogService.Show<RaidStarter>("Start Raid", parameters: new() { [nameof(RaidStarter.Team)] = team });
    }
}
