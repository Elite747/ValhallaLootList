@page "/Characters/{character}"
@inject ApiClient Api
@inject IDialogService DialogService
@inject NavigationManager Nav 
@inject ISnackbar Snackbar 

<ApiExecutor Operation="() => Api.Characters.Get(Character)" Context="character">
    <div class="d-flex align-center mb-3">
        <MudAvatar Class="mr-2" Size="Size.Medium">
            <RaceIcon Race="character.Race" Gender="character.Gender" Size="IconSize.Medium" width="40" height="40" />
        </MudAvatar>
        <MudAvatar Class="mr-2" Size="Size.Medium">
            <ClassIcon PlayerClass="character.Class" Size="IconSize.Medium" width="40" height="40" />
        </MudAvatar>
        <MudText Typo="Typo.h4" GutterBottom="false" Class="mr-2">@character.Name</MudText>
        @if (character.TeamName?.Length > 0)
        {
            <MudLink Href="@("teams/" + character.TeamName)" Typo="Typo.h5">&lt;@character.TeamName&gt;</MudLink>
        }
        <AuthorizeView Roles="@AppRoles.Administrator">
            <MudTooltip Text="Edit">
                <MudIconButton Class="ml-2" Icon="@Icons.Material.Filled.Edit" OnClick="() => EditAsync(character)" />
            </MudTooltip>
            <MudTooltip Text="Delete">
                <MudIconButton Class="ml-2" Color="Color.Error" Icon="@Icons.Material.Filled.DeleteForever" OnClick="() => DeleteAsync(character)" />
            </MudTooltip>
        </AuthorizeView>
    </div>

    <AuthorizeView Roles="@AppRoles.Administrator">
        <AdminView Character="character" />
    </AuthorizeView>

    <ApiExecutor Operation="Api.GetPhaseConfiguration" Context="config">
        <ApiExecutor Operation="() => Api.LootLists.GetForCharacter(character.Id)" Context="lootLists">
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mb-4">
                @foreach (var phase in config.Brackets.Keys.OrderBy(p => p))
                {
                    <MudTabPanel Text="@($"Phase {phase}")">
                        <LootListView Character="character" Phase="phase" LootLists="lootLists" />
                    </MudTabPanel>
                }
            </MudTabs>
        </ApiExecutor>
    </ApiExecutor>
</ApiExecutor>

@code {
    [Parameter] public string Character { get; set; } = string.Empty;

    private async Task EditAsync(CharacterDto character)
    {
        var updatedCharacter = await DialogService.ShowAsync<Create, CharacterDto>(
            "Edit Character",
            parameters: new() { [nameof(Create.EditingCharacter)] = character },
            options: new() { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true });
        if (updatedCharacter is not null)
        {
            character.Name = updatedCharacter.Name;
            character.Race = updatedCharacter.Race;
            character.Gender = updatedCharacter.Gender;
        }
    }

    private async Task DeleteAsync(CharacterDto character)
    {
        if (await DialogService.ShowMessageBox(
            "Delete Character",
            "Are you sure you want to delete this character?",
            "Yes",
            "No") == true)
        {
            await Api.Characters.Delete(character.Id)
                .OnSuccess(_ => Nav.NavigateTo("characters"))
                .SendErrorTo(Snackbar)
                .ExecuteAsync();
        }
    }
}
